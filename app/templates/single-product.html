{% extends 'base.html' %}

{#<link href="http://www.jqueryscript.net/css/jquerysctipttop.css" rel="stylesheet" type="text/css">
<link href="../static/css/timedropper.css" rel="stylesheet" type="text/css">
<!-- datedropper -->
<script src="../static/js/datedropper-javascript.js"></script>
<script>
new dateDropper({
    selector: 'input[type="date"]'
});
</script>
<script src="http://code.jquery.com/jquery-1.12.1.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/socket.io/3.1.2/socket.io.js"></script>
<script src="../static/js/timedropper.js"></script>
<script>$( "#alarm" ).timeDropper();</script>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-36251023-1']);
  _gaq.push(['_setDomainName', 'jqueryscript.net']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' === document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>#}

{% block content %}
    <!-- Chat Style-->
    <link rel="stylesheet" href="../static/css/style_chat.css">
	<div class="wrapper">
		<!--Breadcrumb One Start-->
		<div class="breadcrumb-one mb-120">
            <div class="container">
                <div class="row">
                    <div class="col-12">
                        <div class="breadcrumb-img">
                            <img src="../static/storage/background/product-top-new.jpg" style="width: 1170px" alt="">
                        </div>
                        <div class="breadcrumb-content">
                            <ul>
                                <li><a href="{{ url_for('main.index') }}">{{ _('Home') }}</a></li>
                                <li class="active">{{ _('Single Product') }}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
		<!--Breadcrumb One End-->
		<!--Single Product Area Start-->
		<div class="single-product-area mb-115">
		    <div class="container">
		        <div class="row">
		            <div class="col-md-12 col-lg-5">
		                <div class="product-details-img-tab">
							<!--Important!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!--> 
		                    <!--Product Tab Content Start!!!-->
		                    <div class="tab-content single-product-img">
                              <div class="tab-pane fade show active" id="product1">
                                  <div class="product-large-thumb img-full" style="text-align: center">
                                     <div class="easyzoom easyzoom--overlay" style="text-align: center">
                                        <a href="{{ url_for('static', filename=p2.imagePaths[0].image_path) }}">
                                            <img src="{{ url_for('static', filename=p2.imagePaths[0].image_path) }}" alt="">
                                        </a>
                                        <a href="{{ url_for('static', filename=p2.imagePaths[0].image_path) }}" class="popup-img venobox" data-gall="myGallery"><i class="fa fa-search"></i></a>
                                     </div>
                                  </div>
                              </div>
                                {% if p2.imagePaths.all()|length > 1 %}
                                  <div class="tab-pane fade" id="product2">
                                      <div class="product-large-thumb img-full" style="text-align: center">
                                         <div class="easyzoom easyzoom--overlay">
                                            <a href="{{ url_for('static', filename=p2.imagePaths[1].image_path) }}">
                                              <img src="{{ url_for('static', filename=p2.imagePaths[1].image_path) }}" alt="">
                                            </a>
                                            <a href="{{ url_for('static', filename=p2.imagePaths[1].image_path) }}" class="popup-img venobox" data-gall="myGallery"><i class="fa fa-search"></i></a>
                                         </div>
                                      </div>
                                  </div>
                                    {% if p2.imagePaths.all()|length > 2 %}
                                      <div class="tab-pane fade" id="product3">
                                          <div class="product-large-thumb img-full" style="text-align: center">
                                             <div class="easyzoom easyzoom--overlay">
                                                <a href="{{ url_for('static', filename=p2.imagePaths[2].image_path) }}">
                                                  <img src="{{ url_for('static', filename=p2.imagePaths[2].image_path) }}" alt="">
                                                </a>
                                                <a href="{{ url_for('static', filename=p2.imagePaths[2].image_path) }}" class="popup-img venobox" data-gall="myGallery"><i class="fa fa-search"></i></a>
                                             </div>
                                          </div>
                                      </div>
                                    {% endif %}
                                {% endif %}
                            </div>
		                    <!--Product Tab Content End-->
		                    <!--Product Tab Menu Start-->
		                    <div class="product-menu">
		                        <div class="nav product-tab-menu">
                                  <div class="product-details-img">
                                    <a class="active" data-toggle="tab" href="#product1"><img src="{{ url_for('static', filename=p2.imagePaths[0].image_path) }}" alt=""></a>
                                  </div>
                                  {% if p2.imagePaths.all()|length > 1 %}
                                      <div class="product-details-img">
                                        <a data-toggle="tab" href="#product2"><img src="{{ url_for('static', filename=p2.imagePaths[1].image_path) }}" alt=""></a>
                                      </div>
                                      {% if p2.imagePaths.all()|length > 2 %}
                                          <div class="product-details-img">
                                            <a data-toggle="tab" href="#product3"><img src="{{ url_for('static', filename=p2.imagePaths[2].image_path) }}" alt=""></a>
                                          </div>
                                      {% endif %}
                                  {% endif %}
                                  {#<div class="product-details-img">
                                    <a data-toggle="tab" href="#product2"><img src="{{ p2.imagePaths[1].image_path }}" alt=""></a>
                                  </div>
                                  <div class="product-details-img">
                                    <a data-toggle="tab" href="#product3"><img src="{{ p2.imagePaths[2].image_path }}" alt=""></a>
                                  </div>#}
                                </div>
		                    </div>
		                    <!--Product Tab Menu End-->
		                </div>
		            </div>
		            <div class="col-md-12 col-lg-7">
                        <!--Product Details Content Start-->
						<!--Important!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!-->
		                <div class="product-details-content">
                            <!--Product Nav Start-->
                            <div class="product-nav">
                                <a href="{{ url_for('main.single_product', p=p2.id - 1) }}"><i class="fa fa-angle-left"></i></a>
                                <a href="{{ url_for('main.single_product', p=p2.id + 1) }}"><i class="fa fa-angle-right"></i></a>


                            </div>
                            <!--Product Nav End-->
							<!--Product Name!!!!!-->
		                    <h2>{{ p2.name }}</h2>
							<!--Product Stars!!!!!-->
		                    <div class="single-product-reviews">

                                <a class="review-link" href="#">({{ comments_num }} {{ _('customer review') }})</a>
                            </div>
							<!--Product Price!!!!!-->
                            <div class="single-product-price">
                                <span class="price">${{ p2.price }}</span>
                            </div>
							<!--Product Description!!!!!-->
                            <br>
							<!--Product Stock!!!!!-->
                            <p class="stock in-stock">{{ p2.inventory }} {{ _('in stock') }}</p>
							<!--Add Cart!!!!!-->
                            <div class="single-product-quantity">
                                <div class="add-quantity">
                                     <div class="product-quantity">
                                         <input value="1" type="number" min="1" id="cart_item_count">
                                     </div>
                                    <div class="add-to-link">
                                        <button class="product-btn" data-text="add to cart" id="add_to_cart">{{ _('Add To Wish List') }}</button><span id="cart_op_note" style="margin-left: 10px;color: green"></span>
                                    </div>
                                </div>
                            </div>
                            <label>Want to Book A Test Drive? Select Date and Time!</label>
                            <!--Select Date and Time-->
                            <form action="" name="timepickForm" method="post" novalidate="novalidate">
                                <div class="single-product-quantity">
                                    <label for="alarm"></label>
{#                                    <label for="alarm">Select Date:</label>#}
                                    <input type="date" id="datetime" name="start_date" placeholder="Date">
                                    <label for="datetime"></label>
{#                                    <label for="datetime">Select Time:</label>#}
                                    <input type="text" id="alarm" name="start_time" placeholder="Time">
                                </div>
                                <button type="submit" class="btn_2" style="padding: 6px 26px">{{ _('Submit Request') }}</button>
                                <script>
                                new dateDropper({
                                    selector: 'input[type="date"]'
                                });
                                </script>
                                <script src="http://code.jquery.com/jquery-1.12.1.min.js"></script>
                                <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
                                <script src="../static/js/timedropper.js"></script>
                                <script>$( "#alarm" ).timeDropper();</script>
                                <script type="text/javascript">

                                  var _gaq = _gaq || [];
                                  _gaq.push(['_setAccount', 'UA-36251023-1']);
                                  _gaq.push(['_setDomainName', 'jqueryscript.net']);
                                  _gaq.push(['_trackPageview']);

                                  (function() {
                                    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                                    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                                    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                                  })();
                                </script>
                            </form>
						   <!--Wishlist and Compare!!!!!-->
                            <div class="wishlist-compare-btn" style="margin-top: 30px;">
                                <a class="fa fa-headphones" id="open_chatroom" style="cursor: pointer">{{ _('Customer Service') }}</a>
                            </div>
							<!--Product Category!!!!!-->
                            <div class="product-meta">
                                <span class="posted-in">
                                        {{ _('Categories') }}:
                                    {% for category in p2.categories %}
		                                <a href="{{ url_for('main.shop', status=category.name) }}">&nbsp&nbsp&nbsp{{  category.name }} &nbsp&nbsp&nbsp&nbsp</a>
                                    {% endfor %}
		                            </span>
                            </div>
							<!--Share Product!!!!!-->
		                </div>
		                <!--Product Details Content End-->
		            </div>
		        </div>
		    </div>
		</div>
		<!--Single Product Area End-->

		<!--Product Description Review Area Start-->
		<div class="product-description-review-area mb-100">
		    <div class="container">
		        <div class="row">
		            <div class="col-md-12">
		                <div class="product-review-tab">
		                    <!--Review And Description Tab Menu Start-->
		                    <ul class="nav dec-and-review-menu">
                              <li>
                                <a class="active" data-toggle="tab" href="#description">{{ _('Description') }}</a>
                              </li>
                              <li>
                                <a data-toggle="tab" href="#reviews">{{ _('Reviews') }} ({{ comments_num }})</a>
                              </li>
                            </ul>
		                    <!--Review And Description Tab Menu End-->
		                    <!--Review And Description Tab Content Start-->
		                    <div class="tab-content product-review-content-tab" id="myTabContent-4">
                              <div class="tab-pane fade active show" id="description">
								  <!--Description!!!!!!!!!-->
                                  <div class="single-product-description">
                                      <p>{{ p2.description }}</p>
                                  </div>
                              </div>
                              <div class="tab-pane fade" id="reviews">
								  <!--Reviews!!!!!!!!!-->
                                  <div class="review-page-comment">
                                    <h2>{{ comments_num }} {{ _('review for') }} {{ p2.name }}</h2>
                                    <ul>
                                        <li>
                                            {% for c in comments_show %}
                                                <div class="product-comment">
                                                    <img src="{{ c.author.avatar_path }}">
                                                    <div class="product-comment-content">
                                                        <p class="meta">
                                                            <strong>{{ c.author.username }}</strong> - <span>{{ "{}-{}-{} {}:{}:{}".format(c.timestamp.year, c.timestamp.month, c.timestamp.day, c.timestamp.hour, c.timestamp.minute, c.timestamp.second) }}</span>

                                                        <div class="description">
                                                            <p>{{ c.body }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </li>
                                    </ul>
                                    <div class="review-form-wrapper">
										<!--Add Reviews!!!!!!!!!-->
                                        <div class="input-element">
                                            <strong>{{ _('Add a review') }} </strong>

                                            <form action="" name="commentForm" method="post" novalidate="novalidate" onsubmit="return addComment() ">

                                                <textarea name="comment" class="comment-form-comment", placeholder="Comment", rows="3">
                                                </textarea>
                                                <select name="star" >
                                                    <option>{{ _('Very Good') }}</option>
                                                    <option>{{ _('Good') }}</option>
                                                    <option>{{ _('Moderate') }}</option>
                                                    <option>{{ _('Bad') }}</option>
                                                    <option>{{ _('Very Bad') }}</option>
                                                </select>
                                                <div class="modal-footer" style="border-top: none;">
                                                <button type="submit" class="btn_2" style="padding: 6px 26px">{{ _('Submit') }}</button>
                                                 </div>

                                            </form>
                                        </div>

                                    </div>
                                  </div>
                              </div>
                            </div>
		                    <!--Review And Description Tab Content End-->
		                </div>
		            </div>
		        </div>
		    </div>
		</div>

		<!--Related Product Start-->
		<div class="Related-product mt-105 mb-100">
		    <div class="container">
		        <div class="row">
		            <!--Section Title Start-->
                    <div class="col-12">
                        <div class="section-title text-center mb-35">
                            <h3>{{ _('Related products') }}</h3>
                        </div>
                    </div>
                    <!--Section Title End-->
		        </div>
		        <div class="row">
		            <div class="product-slider-active">
						<!--Slider Start!!!!!!!!!-->
                        {% for product in product_all %}
                            {% if product.id != p2.id %}
                                <!--Single Product Start-->
                                <div class="single-product mb-25">
                                    <div class="product-img img-full">
                                       <a href="{{ url_for('main.single_product', p=product.id) }}">
                                           <img src="{{ url_for('static', filename=product.imagePaths[0].image_path) }}" alt="">
                                        </a>
                                        <div class="product-action">
                                            <ul>
                                                <li><a href="#open-modal" data-toggle="modal" title="Quick view"><i class="fa fa-search"></i></a></li>
                                                <li><a href="#" title="Whishlist"><i class="fa fa-heart-o"></i></a></li>
                                                <li><a href="#" title="Compare"><i class="fa fa-refresh"></i></a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="product-content">
                                        <h2><a href="{{ url_for('main.single_product', p=product.id) }}">{{ product.name }}</a></h2>
                                        <div class="product-price">
                                            <div class="price-box">
                                                <span class="price">${{ product.price }}</span>
                                            </div>
                                            <div class="add-to-cart">
                                                <a tabindex="0" style="cursor: pointer" onclick='add_to_cart("{{ product.id }}", "{{ product.name }}", "{{ url_for('static', filename=product.imagePaths[0].resized_image_path) }}", "{{ product.price }}")'>{{ _('Add To Wish List') }}</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
		            </div>
		        </div>
		    </div>
		</div>
    </div>

    <div class="customer-chat-container" id="chatroom">
        <div class="chat">
          <div class="chat-header clearfix">
            <img src="../static/storage/avatars/avatar_admin.jpg" alt="avatar" style="width: 50px; height: 50px"/>
            <div class="chat-about">
              <div class="chat-with" id="chat_target">AutoWheel {{ _('Official') }}</div>
              <div class="chat-num-messages" id="msgs_num">{{ _('already') }} 0 {{ _('messages') }}</div>
            </div>
            <i class="fa fa-sign-out online" href="#" id="leave_room"></i>
          </div>

          <div class="chat-history">
            <ul id="chat_area" style="list-style: none;">
                
            </ul>
          </div>

          <div class="chat-message clearfix">
            <textarea name="message-to-send" id="message-to-send" placeholder ={{ _('Type your message') }} rows="3"></textarea>

            <i class="fa fa-file-picture-o img-submit" id="send_img_pre"></i>
            <input type="file" id="send_img" style="display: none">

            <button id="send_btn2">{{ _('Send') }}</button>
          </div>
        </div>
    </div>
    <script src="https://cdn.bootcdn.net/ajax/libs/socket.io/3.1.2/socket.io.js"></script>
   <script>
    $(document).ready(function () {
      // constant variables definition
      const MAX_N_RECONNECTION = 8;

      // global variables definition
      var user_name = "";
      var room_name = "waiting";
      var is_connected = false;
      var is_adapted = false;
      var socket = null;
      var n_msgs = 0;
      var current_target = "bot";

      // bot -> customer service
      function bot2service(){
        if (!is_connected){
          socket = io.connect(
              'http://' + document.domain + ':' + location.port + '/chatroom',
              {
                  'reconnection': true,
                  'reconnectionAttempts': MAX_N_RECONNECTION,
                  'reconnectionDelay': 1000}
          );
          user_name = "{{ current_user.username }}"
          socket.emit('user_join_wait', {room: room_name, user: user_name});
          is_connected = true;

          // loss connection error
          socket.on('error', function (data) {
              var note_html = '<li style="width: 100%; text-align: center; color: red">--loss connection, reconnecting--</li>';
              $('#chat_area').append(note_html);
          })

          // loss connection (reconnect success)
          socket.on('reconnect', function () {
              var note_html = '<li style="width: 100%; text-align: center; color: green">--reconnect success--</li>';
              $('#chat_area').append(note_html);
              socket.emit('customer_reconnect', {room: room_name, user: user_name});
              note_html = '<li style="width: 100%; text-align: center; color: lightslategray">--waiting for customer service--</li>';
              $('#chat_area').append(note_html);
          })

          // loss connection (reconnect attempt)
          socket.on('reconnect_attempt', function (attempt) {
            var note_html = '<li style="width: 100%; text-align: center; color: red">--reconnection attempt ';
            note_html += attempt.toString() + '/' + MAX_N_RECONNECTION.toString() +'--</li>';
            $('#chat_area').append(note_html);
            if (attempt === MAX_N_RECONNECTION){
                note_html = '<li style="width: 100%; text-align: center; color: red">--please check your network connection,--</li>';
                $('#chat_area').append(note_html);
                note_html = '<li style="width: 100%; text-align: center; color: red">--and refresh this page--</li>';
                $('#chat_area').append(note_html);
            }
          })

          // admin accept the chat request of user (user join the one2one channel)
          socket.on('admin_accept_response', function (data) {
            if (user_name === data.user){
              socket.emit('join', {room: "chat_channel_"+user_name, user: user_name});
              room_name = "chat_channel_"+user_name;
              var note_html = '<li style="width: 100%; text-align: center; color: deepskyblue">--customer service connected--</li>';
              $('#chat_area').append(note_html);
            }
          })

          // receive message
          socket.on('msg_response', function(data) {
              if (user_name === data.user){

              } else {
                  var msg = data.msg;
                  if (msg !== '') {
                    var t = getCurrentTime();
                    var msg_html = "";
                    msg_html = msg_html + '<li class="clearfix"><div class="message-data">';
                    msg_html = msg_html + '<span class="message-data-name"><i class="fa fa-circle online"></i>' + "AutoWheel Official" + '</span>';
                    msg_html = msg_html + '<span class="message-data-time">' + t + ', Today</span></div>';
                    msg_html = msg_html + '<div class="other-message">' + msg + '</div></li>';
                    $('#chat_area').append(msg_html);
                    scrollToBottom();
                    n_msgs += 1;
                    updateMessageNum(n_msgs);
                  }
              }
          });

          // receive image
          socket.on('img_response', function(data) {
              if (user_name !== data.user){
                  let arrayBufferView = new Uint8Array(data['img']);
                  let blob = new Blob( [ arrayBufferView ], { type: "image" } );
                  let img_url = URL.createObjectURL(blob);
                  var t = getCurrentTime();
                  var img_html = "";
                  img_html = img_html + '<li><div class="message-data">';
                  img_html = img_html + '<span class="message-data-name"><i class="fa fa-circle online"></i>' + "AutoWheel Official" + '</span>';
                  img_html = img_html + '<span class="message-data-time">' + t + ', Today</span></div>';
                  img_html = img_html + '<div class="other-img"><img src="' + img_url + '" style="width: 100%; height: 100%"></div></li>';
                  $('#chat_area').append(img_html);
                  scrollToBottom();
                  n_msgs += 1;
                  updateMessageNum(n_msgs);
              }
          });
        }
      }

      // customer service -> bot
      function service2bot(){
        socket.emit("leave", {room: room_name, user: user_name});
        is_connected = false;
        room_name = "waiting";
        current_target = "bot";
      }

      $('#open_chatroom').on('click', function () {
        // adaptation
        if (window.innerWidth < 600 && !is_adapted){
            let el = document.getElementById("chatroom");
            if (window.innerHeight < 510 || window.innerWidth < 350){
                let alpha_h = window.innerHeight / 510;
                let alpha_w = window.innerWidth / 350;
                let alpha = alpha_h > alpha_w ? alpha_w:alpha_h;
                el.style.transform = "scale("+alpha.toString()+")";
                is_adapted = true;
            }
            el.style.top = String((window.innerHeight-510)/2) + 'px';
            el.style.left = String((window.innerWidth-350)/2) + 'px';
        }
        document.getElementById('chatroom').style.visibility = "visible";
        
        var t = getCurrentTime();
        var msg = "This is Intelligent Bot<br><br>prompt:<br>if you want to connect with customer service, please type @service and send<br>"
        msg += "if you want to switch to bot, please type @bot and send";

        var msg_html = "";
        msg_html = msg_html + '<li class="clearfix"><div class="message-data">';
        msg_html = msg_html + '<span class="message-data-name"><i class="fa fa-circle online"></i>' + "AutoWheel Bot" + '</span>';
        msg_html = msg_html + '<span class="message-data-time">' + t + ', Today</span></div>';
        msg_html = msg_html + '<div class="other-message">' + msg + '</div></li>';
        $('#chat_area').append(msg_html);
      })

      // send message
      $('#send_btn2').on('click', function () {
        scrollToBottom();
        var msg = $('#message-to-send').val();
        if (msg !== '') {
          var t = getCurrentTime();
          var msg_html = "";
          msg_html = msg_html + '<li class="clearfix"><div class="message-data align-right">';
          msg_html = msg_html + '<span class="message-data-time">' + t + ', Today </span>';
          msg_html = msg_html + '<span class="message-data-name">' + user_name + ' </span><i class="fa fa-circle online"></i></div>';
          msg_html = msg_html + '<div class="my-message">' + msg + '</div></li>';
          $('#chat_area').append(msg_html);
          scrollToBottom();
          $('#message-to-send').val('');
          if (current_target !== 'bot') {
            if (msg === '@bot') {
                current_target = "bot";
                var note_html = '<li style="width: 100%; text-align: center; color: lightslategray">--return to bot--</li>';
                service2bot();
                $('#chat_area').append(note_html);
            } else if (msg === "@service") { } 
            else {
                socket.emit('send', {room: room_name, msg: msg, user: user_name});
            }
          } else {
            if (msg === "@service") {
                current_target = "service";
                var note_html = '<li style="width: 100%; text-align: center; color: lightslategray">--waiting for customer service--</li>'
                bot2service();
                $('#chat_area').append(note_html);
            } else if (msg === '@bot') { } 
            else {
                $.ajax({
                    type: "POST",
                    async:true,
                    url: "{{ url_for('chat.bot') }}",
                    data: {"msg-to-bot":msg},
                    success: function(res) {
                        var t = getCurrentTime();
                        var msg_html = "";
                        msg_html = msg_html + '<li class="clearfix"><div class="message-data">';
                        msg_html = msg_html + '<span class="message-data-name"><i class="fa fa-circle online"></i>' + "AutoWheel Bot" + '</span>';
                        msg_html = msg_html + '<span class="message-data-time">' + t + ', Today</span></div>';
                        msg_html = msg_html + '<div class="other-message">' + res['msg-back'] + '</div></li>';
                        $('#chat_area').append(msg_html);                    
                    },
                    error: function (res) {
                        alert('error')
                    }
                })
            }
          }
          n_msgs += 1;
          updateMessageNum(n_msgs);
        }
      })

      // send image
      $('#send_img_pre').on('click', function () {
        if (current_target !== 'bot') {
            $('#send_img').click();
        } else {
            note_html = '<li style="width: 100%; text-align: center; color: red">--image not supported for bot--</li>';
            $('#chat_area').append(note_html);
        }
      })
      $('#send_img').on('change', function () {
        var file_name = document.getElementById('send_img').files[0].name;
        var file_format = file_name.substring(file_name.lastIndexOf(".")).toLowerCase();
        // check format
        if(!file_format.match(/.png|.jpg|.jpeg/) ) {
            alert("Only .png, .jpg, and .jpeg format image are supported !")
            return;
        }
        var t = getCurrentTime();
        var img_html = "";
        var src = window.URL.createObjectURL(this.files[0]);
        img_html = img_html + '<li class="clearfix2"><div class="message-data align-right">';
        img_html = img_html + '<span class="message-data-time">' + t + ', Today </span>';
        img_html = img_html + '<span class="message-data-name">' + user_name + ' </span><i class="fa fa-circle online"></i></div>';
        img_html = img_html + '<div class="my-img"><img src="' + src + '" style="width: 100%; height: 100%"></div></li>';
        $('#chat_area').append(img_html);
        scrollToBottom();
        socket.emit('send_img', {room: room_name, file_name: file_name, user: user_name, img: $('#send_img')[0].files[0]});
        n_msgs += 1;
        updateMessageNum(n_msgs);
      })

      // leave room button
      $('#leave_room').on('click', function () {
        if (current_target === 'service') {
            socket.emit("leave", {room: room_name, user: user_name})
        }
        $('#chat_area').html('');
        $('#user_name').val('');
        $('#open_chatroom').val("Connect");
        is_connected = false;
        room_name = "waiting";
        n_msgs = 0;
        current_target = "bot"
        updateMessageNum(n_msgs);
        document.getElementById('chatroom').style.visibility = "hidden";
      })

      // leave room before the page refresh, close, ...
      window.onbeforeunload = function (event) {
          if (socket && current_target === 'service'){
              socket.emit("leave", {room: room_name, user: user_name})
          }
      }
    })

    // add to shopping cart button
    $('#add_to_cart').on('click', function () {
        const count = $('#cart_item_count').val();
        $.post(
            "{{ url_for('main.add_to_cart') }}",
            {'product_id': "{{ p2.id }}", 'product_count': count},
            function(data) {
                const status = data['status'];
                if (status === 0){
                    document.getElementById("cart_op_note").style.color = "green";
                    document.getElementById("cart_op_note").innerText = "Success";
                    document.getElementById("cart_op_note").style.display="inline";
                    setTimeout(function hide_note() {
                        document.getElementById("cart_op_note").style.display="none";
                    }, 3000);

                    document.getElementById("mini_cart_count").innerText=data['count'];
                    document.getElementById("mini_cart_price").innerText="$"+data['product_price'];
                    document.getElementById("mini_cart_subtotal").innerText="$"+data['product_price'];

                    // update mini-cart list
                    if (data['count'] <= 3){
                        var mci_html = "";  // mini cart item html
                        mci_html += '<li class="single-cart-item"><div class="cart-img">';
                        mci_html += '<a href="{{ url_for("main.single_product", p=p2.id) }}">';
                        mci_html += '<img src="{{ url_for('static', filename=p2.imagePaths[0].image_path) }}" alt="" style="width: 80px; height: 80px"></a></div>';
                        mci_html += '<div class="cart-content"><h5 class="product-name">';
                        mci_html += '<a href="{{ url_for("main.single_product", p=p2.id) }}">{{ p2.name }}</a></h5>';
                        mci_html += '<span class="cart-price">' + count.toString() +' × ${{ p2.price }}</span></div></li>';
                        $('#mini_cart_list').append(mci_html);
                    }
                } else {
                    document.getElementById("cart_op_note").style.color = "red";
                    document.getElementById("cart_op_note").innerText = "Already in Cart";
                    document.getElementById("cart_op_note").style.display="inline";
                    setTimeout(function hide_note() {
                        document.getElementById("cart_op_note").style.display="none";
                    }, 3000);
                }
            }
        )
    })

    function add_to_cart(id, name, image_path, price) {
        $.post(
            "{{ url_for('main.add_to_cart') }}",
            {'product_id': id, 'product_count': 1},
            function(data) {
                const status = data['status'];
                if (status === 0){
                    let msg = "Product " + name + " added into your shopping cart";
                    $("#flash_messages").append('<div class="alert alert-warning" style="margin-bottom: 0"><button type="button" class="close" data-dismiss="alert">x</button>' + msg + '</div>');
                    setTimeout(function hide_note() {
                        document.getElementById("flash_messages").innerHTML="";
                    }, 3000);

                    document.getElementById("mini_cart_count").innerText=data['count'];
                    document.getElementById("mini_cart_price").innerText="$"+data['product_price'];
                    document.getElementById("mini_cart_subtotal").innerText="$"+data['product_price'];

                    // update mini-cart list
                    if (data['count'] <= 3){
                        var mci_html = "";  // mini cart item html
                        mci_html += '<li class="single-cart-item"><div class="cart-img">';
                        mci_html += '<a href="{{ url_for("main.single_product", p=id) }}">';
                        mci_html += '<img src=' + image_path + ' alt="" style="width: 80px; height: 80px"></a></div>';
                        mci_html += '<div class="cart-content"><h5 class="product-name">';
                        mci_html += '<a href="{{ url_for("main.single_product", p=id) }}">' + name + '</a></h5>';
                        mci_html += '<span class="cart-price">1 × $' + price.toString() + '</span></div></li>';
                        $('#mini_cart_list').append(mci_html);
                    }
                } else {
                    let msg = "Product " + name + " has already in your shopping cart";
                    $("#flash_messages").append('<div class="alert alert-warning" style="margin-bottom: 0"><button type="button" class="close" data-dismiss="alert">x</button>' + msg + '</div>');
                    setTimeout(function hide_note() {
                        document.getElementById("flash_messages").innerHTML="";
                    }, 3000);
                }
            }
        )
    }

    function updateMessageNum(n_msgs) {
      document.getElementById("msgs_num").innerText = 'already ' + n_msgs + ' messages';
    }

    function scrollToBottom() {
       $('.chat-history').scrollTop($('.chat-history')[0].scrollHeight);
    }

    function getCurrentTime() {
      return new Date().toLocaleTimeString().
              replace(/([\d]+:[\d]{2})(:[\d]{2})(.*)/, "$1$3");
    }

    window.onload = () => {
         let el = document.getElementById("chatroom");
         el.onmousedown = (e) => {
             let disX = e.clientX - el.offsetLeft;
             let disY = e.clientY - el.offsetTop;
             document.onmousemove = function (e) {
                 let tX = e.clientX - disX;
                 let tY = e.clientY - disY;

                 if (tX >= 0 && tX <= window.innerWidth - el.offsetWidth) {
                    el.style.left = tX + 'px';
                 }
                 if (tY >= 0 && tY <= window.innerHeight - el.offsetHeight) {
                    el.style.top = tY + 'px';
                 }
             };
             document.onmouseup = function (e) {
                 document.onmousemove = null;
                 document.onmouseup = null;
             };
        }
    }

    function addComment(){
        if(!commentForm.comment.value){
            alert('comment should not be empty')
            commentForm.comment.focus();
            return false;
        }
    }
   </script>
{% endblock %}
<!-- </body>
</html> -->
