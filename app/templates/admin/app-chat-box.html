{% extends 'admin/staff-base.html' %}

{% block content %}
    <!--start page wrapper -->
    <div class="page-wrapper">
        <div class="page-content">
            <div class="chat-wrapper" id="chat-wrapper">
                    <div class="chat-sidebar">
                        <!-- <div class="chat-sidebar-header">
                            <div class="d-flex align-items-center">
                                <div class="chat-user-online"><img src="static/picture/110x110.jpg" width="45" height="45" class="rounded-circle" alt=""></div>
                                <div class="flex-grow-1 ms-2">
                                    <p class="mb-0">Rachel Zane</p>
                                </div>
                                <div class="dropdown">
                                    <div class="cursor-pointer font-24 dropdown-toggle dropdown-toggle-nocaret" data-bs-toggle="dropdown">
                                        <i class='bx bx-dots-horizontal-rounded'></i>
                                    </div>
                                    <div class="dropdown-menu dropdown-menu-end">
                                        <a class="dropdown-item" href="javascript:;">Settings</a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="javascript:;">Help & Feedback</a>
                                        <a class="dropdown-item" href="javascript:;">Enable Split View Mode</a>
                                        <a class="dropdown-item" href="javascript:;">Keyboard Shortcuts</a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="javascript:;">Sign Out</a>
                                    </div>
                            </div>
                        </div>
                        <div class="mb-3"></div>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">
                                <i class='bx bx-search'></i>
                            </span>
                            <input type="text" class="form-control" placeholder="People, groups, & messages">
                            <span class="input-group-text"><i class='bx bx-dialpad'></i></span>
                        </div>
                        <div class="chat-tab-menu mt-3">
                            <ul class="nav nav-pills nav-justified">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="pill" href="javascript:;">
                                        <div class="font-24"><i class='bx bx-conversation'></i></div>
                                        <div><small>Chats</small></div>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="pill" href="javascript:;">
                                        <div class="font-24"><i class='bx bx-phone'></i></div>
                                        <div><small>Calls</small></div>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="pill" href="javascript:;">
                                        <div class="font-24"><i class='bx bxs-contact'></i></div>
                                        <div><small>Contacts</small></div>
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="pill" href="javascript:;">
                                        <div class="font-24"><i class='bx bx-bell'></i></div>
                                        <div><small>Notifications</small></div>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div> -->
                    <div class="chat-sidebar-content">
                        <div class="tab-content" id="pills-tabContent">
                            <div class="tab-pane fade show active" id="pills-Chats">
                                <div class="p-3">
                                    <div class="meeting-button d-flex justify-content-between">
                                        <!-- <div class="dropdown">
                                            <a href="#" class="btn btn-light btn-sm radius-30 dropdown-toggle dropdown-toggle-nocaret" data-bs-toggle="dropdown">
                                                <i class='bx bx-video me-2'></i>History<i class='bx bxs-chevron-down ms-2'></i>
                                            </a>
                                            <div class="dropdown-menu"><a class="dropdown-item" href="#">All</a>
                                                <a class="dropdown-item" href="#">24 Hours</a>
                                            </div>
                                        </div>
                                        <div class="dropdown">
                                            <a href="#" class="btn btn-light btn-sm radius-30 dropdown-toggle dropdown-toggle-nocaret" data-bs-toggle="dropdown" data-display="static">
                                                <i class='bx bxs-edit me-2'></i>Online<i class='bx bxs-chevron-down ms-2'></i>
                                            </a>
                                            <div class="dropdown-menu dropdown-menu-right">
                                                <a class="dropdown-item" href="#">Waiting</a>
                                                <a class="dropdown-item" href="#">Chat Bot</a>
                                            </div>
                                    </div> -->
                                </div>
                                <!-- <div class="dropdown mt-3"><a href="#" class="text-uppercase text-secondary dropdown-toggle dropdown-toggle-nocaret" data-bs-toggle="dropdown">Recent Chats <i class='bx bxs-chevron-down'></i></a>
                                    <div class="dropdown-menu"><a class="dropdown-item" href="#">Recent Chats</a><a class="dropdown-item" href="#">Hidden Chats</a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="#">Sort by Time</a>
                                        <a class="dropdown-item" href="#">Sort by Unread</a>
                                        <div class="dropdown-divider"></div>
                                        <a class="dropdown-item" href="#">Show Favorites</a>
                                    </div>
                                </div> -->
                            </div>
                            <div class="chat-list" id="chat-list">
                                <div class="list-group list-group-flush" id="chat-list-inner">
                                    
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="chat-header d-flex align-items-center">
                <div class="chat-toggle-btn">
                    <i class='bx bx-menu-alt-left'></i>
                </div>
                <div>
                    <h4 class="mb-1 font-weight-bold" id="chat_target"></h4>
                    <div class="list-inline d-sm-flex mb-0 d-none">
                        <a href="javascript:;" class="list-inline-item d-flex align-items-center text-secondary">
                            <small class='bx bxs-circle me-1 chart-online'></small>Active Now
                        </a>
                        <!-- <a href="javascript:;" class="list-inline-item d-flex align-items-center">|</a>
                        <a href="javascript:;" class="list-inline-item d-flex align-items-center"><i class='bx bx-images me-1'></i>Gallery</a>
                        <a href="javascript:;" class="list-inline-item d-flex align-items-center">|</a>
                        <a href="javascript:;" class="list-inline-item d-flex align-items-center"><i class='bx bx-search me-1'></i>Find</a> -->
                    </div>
                </div>
                <!-- <div class="chat-top-header-menu ms-auto">
                    <a href="javascript:;"><i class='bx bx-video'></i></a>
                    <a href="javascript:;"><i class='bx bx-phone'></i></a>
                    <a href="javascript:;"><i class='bx bx-user-plus'></i></a>
                </div> -->
            </div>
            <div class="chat-content" id="chat-content">
                
            </div>
            <div class="chat-footer d-flex align-items-center">
                <div class="flex-grow-1 pe-2">
                    <div class="input-group"> 
                        <!-- <span class="input-group-text"><i class='bx bx-smile'></i></span> -->
                        <input type="text" class="form-control" placeholder="Type a message" id="message-to-send">
                    </div>
                </div>
                <div class="chat-footer-menu">
                    <input type="file" id="send_img" style="display: none">
                    <a href="javascript:;"><i class='bx bx-image' id="send_img_pre"></i></a>
                    <!-- <a href="javascript:;"><i class='bx bxs-contact'></i></a>
                    <a href="javascript:;"><i class='bx bx-microphone'></i></a>
                    <a href="javascript:;"><i class='bx bx-dots-horizontal-rounded'></i></a> -->
                    <button class="btn btn-light" style="margin-bottom: 5px;" id="send_btn2">Send</button>
                </div>
            </div>
            <!--start chat overlay-->
            <div class="overlay chat-toggle-btn-mobile"></div>
            <!--end chat overlay-->
            </div>
        </div>
    </div>
    <!--end page wrapper -->
    
    <script src="../../static/staff/js/perfect-scrollbar.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/socket.io/3.1.2/socket.io.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>
        new PerfectScrollbar('.chat-list');
        new PerfectScrollbar('.chat-content');

        $(document).ready(function () {
            var user_name = "";
            var room_name = "";
            var socket = null;

            function adjust_chat_box_size(){
                const fix_percentage = 600 / 714;
                var h_bias = parseInt(window.innerHeight * fix_percentage - 600);
                document.getElementById("chat-wrapper").style.height = (600 + h_bias).toString() + "px";
                document.getElementById("chat-content").style.height = (450 + h_bias).toString() + "px";
                document.getElementById("chat-list").style.height = (300 + h_bias).toString() + "px";
            }

            adjust_chat_box_size()

            window.onresize = function(){
                adjust_chat_box_size();
            }

            function set_online_status(status){
                if (status){
                    document.getElementById('online-status').style.color = "rgb(47, 255, 61)";
                    document.getElementById('online-status-text').innerText = "Active";
                } else {
                    document.getElementById('online-status').style.color = "rgb(255, 47, 165)";
                    document.getElementById('online-status-text').innerText = "Pending";
                }
            }

            function getCurrentTime() {
                return new Date().toLocaleTimeString().
                        replace(/([\d]+:[\d]{2})(:[\d]{2})(.*)/, "$1$3");
            }

            function scrollToBottom() {
                $('#chat-content').scrollTop($('#chat-content')[0].scrollHeight);
            }

            function make_chat(target, t, latest_msg){
                var chat_html = '<a href="javascript:;" class="list-group-item active" id="user_' + target +'">';
                chat_html += '<div class="d-flex">';
                chat_html += '<div class="chat-user-online" style="color: blue" id="status_point_' + target +'">';
                chat_html += '<img src="../../static/storage/avatars/default_avatar.jpg" width="42" height="42" class="rounded-circle" alt=""></div>';
                chat_html += '<div class="flex-grow-1 ms-2">';
                chat_html += '<h6 class="mb-0 chat-title">' + target + '</h6>';
                chat_html += '<p class="mb-0 chat-msg">' + cast_text(latest_msg, 25) + '</p></div><div class="chat-time">';
                chat_html += t + '</div></div></a>';
                return chat_html;
            }

            function make_self_msg(t, msg, type){
                var msg_element = '<div class="chat-content-rightside"><div class="d-flex"><div class="flex-grow-1 me-2"> <p class="mb-0 chat-time text-end">you, ';
                msg_element += t + '</p><p class="chat-right-msg">';
                if (type > 0) {
                    msg = '<img src="' + msg + '" style="width: 100%; height: 100%">';
                }
                msg_element += msg + '</p></div></div></div>'
                return msg_element
            }

            function make_target_msg(target, t, msg, type){
                var msg_element = '<div class="chat-content-leftside"><div class="d-flex"><img src="static/picture/110x110.jpg" width="48" height="48" class="rounded-circle" alt="">';
                msg_element += '<div class="flex-grow-1 ms-2"><p class="mb-0 chat-time">';
                msg_element += target + ', ' + t + '</p><p class="chat-left-msg">';    
                if (type > 0) {
                    msg = '<img src="' + msg + '" style="width: 100%; height: 100%">';
                }        
                msg_element += msg + '</p></div></div></div>';
                return msg_element
            }

            function cast_text(msg, max_length){
                msg = msg.replace('<br>', ' ').replace('<br>', ' ');
                return msg.slice(0, max_length<msg.length?max_length:msg.length)
            }

            // socket connection
            socket = io.connect('http://' + document.domain + ':' + location.port + '/chatroom');
            socket.emit('admin_join_wait', {room: "waiting"});

            // user join waiting room
            socket.on('user_wait_response', function (data) {
                var _user_name = data.user;
                var chat_html = make_chat(_user_name, getCurrentTime(), "");
                $('#chat-list-inner').append(chat_html);

                // admin left user list item
                $('#user_' + _user_name).on('click', function () {
                    user_name = _user_name;
                    document.getElementById("chat_target").innerText = _user_name;
                    //   document.getElementById("status_" + _user_name).innerText = "online";
                    //   $('#status_point_' + _user_name).attr("class", "fa fa-circle online");
                    //   setChatTargetInfoVisibility("visible");
                    socket.emit('admin_accept', {room: "waiting", user: _user_name});
                    room_name = "chat_channel_" + _user_name;
                    $('#chat-content').html('');
                    socket.emit('admin_request_recover', {room: room_name, user: _user_name});
                })
            })

            // receive message
            socket.on('msg_response', function(data) {
                if ("admin" === data.user){

                } else {
                    var msg = data.msg;
                    var rp_user_name = data.user;
                    if (user_name !== rp_user_name){
                        return;
                    }
                    if (msg !== '') {
                        var t = getCurrentTime();
                        var msg_html = make_target_msg(rp_user_name, t, msg, 0);
                        $('#chat-content').append(msg_html);
                        scrollToBottom();
                    }
                }
            });

            // receive image
            socket.on('img_response', function(data) {
                if ("admin" !== data.user){
                    let arrayBufferView = new Uint8Array(data['img']);
                    let blob = new Blob( [ arrayBufferView ], { type: "image" } );
                    let img_url = URL.createObjectURL(blob);
                    var rp_user_name = data.user;
                    var t = getCurrentTime();
                    var img_html = make_target_msg(rp_user_name, t, img_url, 1);
                    $('#chat-content').append(img_html);
                }
            });

            // user leave the waiting room / channel
            socket.on("leave_response", function (data) {
                $('#user_'+data.user).remove();
                if (data.room !== "waiting"){
                    $('#chat-content').html('');
                }
                socket.emit("close", {room: data.room});
            })

            // message recover
            socket.on("msg_recover_response", function (data) {
                var msg_html = "";
                var t = "";
                var msg = "";
                var user = "";
                var type = 0;
                for (var i=0; i<data["length"];i++){
                    t = data[String(i)]['time'];
                    msg = data[String(i)]['msg'];
                    user = data[String(i)]['user'];
                    type = data[String(i)]['type']

                    if (user === "admin"){
                        msg_html = make_self_msg(t, msg, type);
                    } else {
                        msg_html = make_target_msg(user, t, msg, type);
                    }
                    $('#chat-content').append(msg_html);
                }
                scrollToBottom();
            })

            // user search
            $('#search').on('input', function(){
                var term = $('#search').val();
                var list = document.getElementById("user_list_ul");
                var children = list.getElementsByTagName("li");
                for (var i=0; i<children.length; i++){
                    var li_id = children[i].getAttribute("id");
                    if (!li_id.includes(term)){
                    $('#'+li_id).hide();
                    } else {
                    $('#'+li_id).show();
                    }
                }
            })
            
            // send message
            $('#send_btn2').on('click', function () {
                scrollToBottom();
                var msg = $('#message-to-send').val();
                if (msg !== '') {
                    var t = getCurrentTime();
                    var msg_html = make_self_msg(t, msg, 0);
                    $('#chat-content').append(msg_html);
                    scrollToBottom();
                    $('#message-to-send').val('');
                    socket.emit('send', {room: room_name, msg: msg, user: "admin"});
                }
            })

            // send image
            $('#send_img_pre').on('click', function () {
                $('#send_img').click();
            })
            $('#send_img').on('change', function () {
                var file_name = document.getElementById('send_img').files[0].name;
                var file_format = file_name.substring(file_name.lastIndexOf(".")).toLowerCase();
                // check format
                if(!file_format.match(/.png|.jpg|.jpeg/) ) {
                    alert("Only .png, .jpg, and .jpeg format image are supported !")
                    return;
                }
                var t = getCurrentTime();
                var src = window.URL.createObjectURL(this.files[0]);
                var img_html = make_self_msg(t, src, 1);
                $('#chat-content').append(img_html);
                scrollToBottom();
                socket.emit('send_img', {room: room_name, file_name: file_name, user: "admin", img: $('#send_img')[0].files[0]});
            })
        })

    </script>
    <!--app JS-->
    <script src="{{url_for('static', filename='staff/js/app.js')}}"></script>

{% endblock %}